generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Item {
  id      String       @id @default(uuid())
  name    String
  slug    String?      @unique // Slug is optional because we rely on triggers to populate it on insert and update.
  recipes Recipe[]
  usedIn  Ingredient[]
  nodes   Node[]

  @@map("Items")
}

model Recipe {
  id          String       @id @default(uuid())
  name        String
  slug        String?      @unique // Slug is optional because we rely on triggers to populate it on insert and update.
  item        Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId      String
  quantity    Int
  time        Float
  ingredients Ingredient[]
  nodes       Node[]

  @@map("Recipes")
}

model Ingredient {
  id       String   @id @default(uuid())
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId   String
  quantity Int
  recipes  Recipe[]

  @@unique(name: "itemId_quantity", fields: [itemId, quantity])
  @@map("Ingredients")
}

model Node {
  id   String @id @default(uuid())
  name String

  type NodeType

  item   Item?   @relation(fields: [itemId], references: [id])
  itemId String?

  recipe   Recipe? @relation(fields: [recipeId], references: [id])
  recipeId String?

  children Node[] @relation("NodeChildren")
  parent   Node?  @relation("NodeChildren", fields: [parentId], references: [id], onDelete: Cascade)

  parentId String?
  order    Int

  /// Ensures that each Item can only be referenced by a single Node.
  @@unique([itemId], name: "unique_node_item")
  /// Ensures that each Recipe can only be referenced by a single Node.
  @@unique([recipeId], name: "unique_node_recipe")
  @@index([parentId, order])
  @@map("Nodes")
}

enum NodeType {
  folder
  item
  recipe
}
